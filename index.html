<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agro-Chem Invest - Investment Platform</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        /* áŠ áŒ á‰ƒáˆ‹á‹­ á‹¨áŒˆáŒ½ ááˆ­áˆ›á‰µ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #e9f5e9;
        }
        
        /* á‹¨ Login/Register áŒˆáŒ½ áŒ€áˆ­á‰£ */
        .login-register-page {
            background-image: linear-gradient(135deg, #1e5a2c 0%, #387c38 100%); 
            display: flex; 
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100%;
            position: fixed; 
            top: 0;
            left: 0;
            z-index: 10;
        }

        .container {
            background-color: #ffffff;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        h1 {
            color: #1e5a2c;
            margin-bottom: 5px;
        }

        p {
            color: #555;
            margin-bottom: 20px;
        }

        /* Tab Buttons Style */
        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .tab-buttons button {
            padding: 12px 20px;
            border: none;
            background-color: #f0f0f0;
            color: #555;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s, color 0.3s;
            flex-grow: 1;
        }
        
        .tab-buttons button.active {
            background-color: #387c38;
            color: white;
        }

        .form-box {
            display: none; 
        }

        .form-box.active {
            display: block; 
        }

        .input-group {
            text-align: left;
            margin-bottom: 10px; 
        }

        .input-group label {
            display: block;
            margin-bottom: 3px; 
            font-weight: bold;
            font-size: 14px; 
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box; 
            font-size: 15px;
        }
        
        /* áŠ á‹²áˆµ áˆµá‰³á‹­áˆ: áˆˆ Register á‰áˆá áŠ¥áŠ“ Referral Input áŒáŠ• áˆˆáŒáŠ• áŠ¥áŠ•á‹²áˆ†áŠ‘ */
        .input-group-half {
            display: flex;
            gap: 10px; /* á‰  Input áŠ¥áŠ“ Button áˆ˜áŠ«áŠ¨áˆ áŠ­áá‰°á‰µ áˆˆáˆ˜ááŒ áˆ­ */
            align-items: flex-end; /* á‰áˆá‰ áŠ¨á‰³á‰½ áŠ¥áŠ•á‹²áˆ°áˆˆá */
            margin-bottom: 10px;
        }
        .input-group-half .input-group {
            flex-grow: 1;
            margin-bottom: 0; /* á‹µáˆ­á‰¥ margin áŠ¥áŠ•á‹³á‹­áˆ†áŠ• */
        }
        .input-group-half .submit-btn-register {
            width: 150px; /* áˆˆ Register á‰áˆá áˆµá‹á‰µ áˆ˜áˆµáŒ á‰µ */
            padding: 10px 14px;
            font-size: 16px;
            margin-top: 0; /* áŠ¨áˆ‹á‹­ á‹«áˆˆá‹ margin áŠ¥áŠ•á‹²áŒ á‹ */
        }
        /* á‹¨áŒáŠ• áˆˆáŒáŠ• á‰…áŒ¹ á‹áˆµáŒ¥ áŠ«áˆáˆ†áŠ submit-btn áˆ™áˆ‰ áˆµá‹á‰µ áŠ¥áŠ•á‹²á‹­á‹ */
        .form-box .submit-btn:not(.submit-btn-register) {
            width: 100%;
            padding: 14px;
            font-size: 18px;
            margin-top: 18px; 
        }

        .submit-btn {
            background-color: #1e5a2c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }
        .submit-btn:active {
            transform: translateY(1px);
        }

        .submit-btn:hover {
            background-color: #387c38;
        }

        .message {
            margin-top: 10px; 
            font-weight: bold;
        }

        .success {
            color: #4CAF50; 
        }

        .error {
            color: #f44336; 
        }

        /* ***** Dashboard Style ***** */
        .dashboard-page {
            display: none; 
            width: 100%;
            max-width: 1000px;
            background-color: #ffffff;
            padding: 20px 40px 80px 40px; 
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); 
            text-align: center;
            position: relative; 
            box-sizing: border-box; 
        }

        /* [ADMIN-FEATURE] Admin Dashboard Style */
        .admin-dashboard-page {
            display: none;
            width: 100%;
            max-width: 1200px; /* áˆ°á‹ á‹«áˆˆ áŒˆáŒ½ */
            background-color: #f9f9f9;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        .admin-header {
            text-align: left;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #387c38;
        }
        .admin-header h2 {
            color: #f44336;
            margin: 0;
        }
        .admin-transaction-list {
            margin-top: 20px;
            text-align: left;
        }
        .admin-transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .admin-transaction-info {
            flex-grow: 1;
            padding-right: 20px;
        }
        .admin-transaction-info p {
            margin: 3px 0;
            font-size: 14px;
        }
        .admin-actions button {
            padding: 8px 15px;
            margin-left: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .admin-actions .approve-btn {
            background-color: #4CAF50;
            color: white;
        }
        .admin-actions .approve-btn:hover {
            background-color: #387c38;
        }
        .admin-actions .reject-btn {
            background-color: #f44336;
            color: white;
        }
        .admin-actions .reject-btn:hover {
            background-color: #d32f2f;
        }
        .admin-logout-btn {
            background-color: #555;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }
        .admin-logout-btn:hover {
            background-color: #333;
        }
        
        /* Bottom Navigation Bar Style (áŠ áˆá‰°áŠáŠ«áˆ) */
        .bottom-navbar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: #1e5a2c; 
            padding: 10px 0;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
            box-sizing: border-box;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
            z-index: 20;
        }
        
        .bottom-navbar button {
            background: none;
            border: none;
            color: #c8e6c9;
            font-size: 14px;
            font-weight: 500;
            padding: 8px 10px;
            cursor: pointer;
            transition: color 0.3s, background-color 0.3s;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .bottom-navbar button:hover {
            color: white; 
        }
        
        .bottom-navbar button.nav-active {
            color: #FFEB3B; 
        }
        
        /* Icons (áˆˆáˆ™áŠ¨áˆ« á‹«áˆ…áˆ) */
        .bottom-navbar button::before {
            content: '';
            font-size: 20px;
            margin-bottom: 3px;
            font-family: Arial, sans-serif; 
        }
        #nav-home::before { content: 'ğŸ '; }
        #nav-investment::before { content: 'ğŸ“ˆ'; }
        #nav-account::before { content: 'ğŸ‘¤'; }
        #nav-team::before { content: 'ğŸ‘¥'; }
        
        /* ***** á‹¨áŒˆáŒ½ á‹­á‹˜á‰¶á‰½ (Content Sections) ***** */
        .page-content {
            display: none;
            animation: fadeIn 0.5s;
            padding-bottom: 20px; 
            text-align: left;
        }
        
        .page-content.active {
            display: block;
        }
        
        /* [ADMIN-FEATURE] Transaction Status Colors */
        .status-Pending { color: #ff9800; font-weight: bold; }
        .status-Completed { color: #4CAF50; font-weight: bold; }
        .status-Rejected { color: #f44336; font-weight: bold; }
        
        /* á‹¨á‰°á‰€áˆ©á‰µ áˆµá‰³á‹­áˆá‰½ áŠ áˆá‰°áŠáŠ©áˆ */
        .header {
            display: flex;
            justify-content: start; 
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        /* Home Page Cards and Buttons */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .info-card {
            padding: 25px; 
            border-radius: 15px; 
            text-align: left;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        .balance-card { background-color: #e8f5e9; border: 1px solid #c8e6c9; }
        .profit-card { background-color: #fff3e0; border: 1px solid #ffe0b2; }
        .info-card h2 { color: #555; font-size: 18px; margin-top: 0; margin-bottom: 5px; }
        .amount-display { font-size: 38px; font-weight: 900; color: #1e5a2c; margin: 0; }
        .profit-amount-display { color: #ff9800; }
        .action-buttons { display: flex; gap: 20px; margin-bottom: 40px; justify-content: center; }
        .action-buttons button { padding: 15px 40px; font-size: 17px; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s, transform 0.1s; font-weight: bold; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); flex-grow: 1; max-width: 300px; }
        #deposit-btn { background-color: #4CAF50; color: white; }
        #deposit-btn:hover { background-color: #387c38; }
        #withdraw-btn { background-color: #f44336; color: white; }
        #withdraw-btn:hover { background-color: #d32f2f; }
        
        
        /* Deposit/Withdraw Forms (áŠ áˆá‰°áŠáŠ©áˆ) */
        #deposit-form-content, #withdraw-form-content {
            padding: 20px;
            background-color: #f7fcf7;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* Account Buttons (áŠ áˆá‰°áŠáŠ©áˆ) */
        .account-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 350px;
            margin: 0 auto;
        }
        .account-buttons button {
            padding: 15px 20px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: white; 
        }

        #customer-service-btn { background-color: #008CBA; }
        #customer-service-btn:hover { background-color: #007bb5; }
        #transaction-history-btn { background-color: #FF9800; }
        #transaction-history-btn:hover { background-color: #e68900; }
        #change-password-btn { background-color: #387c38; }
        #change-password-btn:hover { background-color: #1e5a2c; }
        #logout-btn-account { background-color: #f44336; }
        #logout-btn-account:hover { background-color: #d32f2f; }
        
        /* Investment Page Styles */
        .plan-grid {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap; 
            justify-content: center;
        }
        .plan-button {
            background-color: #f7fcf7;
            border: 2px solid #387c38;
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            max-width: 200px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .plan-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            background-color: #e8f5e9;
        }
        .plan-button h4 {
            color: #1e5a2c;
            font-size: 20px;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .plan-button .plan-details p {
            margin: 5px 0;
            color: #555;
            font-size: 15px;
        }
        .plan-button .daily-rate {
            font-size: 18px;
            font-weight: bold;
            color: #ff9800;
            margin-top: 10px;
        }
    </style>

</head>
<body>

    <div id="login-register-area" class="login-register-page">
        <div class="container">
            <h1>Agro-Chem Invest</h1>
            <p>á‰ áŒá‰¥áˆ­áŠ“ áŠ¬áˆšáŠ«áˆ áŠ¢áŠ•á‰¨áˆµá‰µ á‰ áˆ›á‹µáˆ¨áŒ á‰ á‹¨á‰€áŠ‘ á‰µáˆ­áá‹áŠ• á‹«áŒáŠ™!</p>

            <div class="tab-buttons">
                <button id="login-tab" class="active">Login</button>
                <button id="register-tab">Register</button>
            </div>

            <form id="login-form" class="form-box active">
                <h2>Login</h2>
                <div class="input-group">
                    <label for="login-identifier">áˆµáˆáŠ­ á‰áŒ¥áˆ­ (áˆˆá‰°áŒ á‰ƒáˆš) / Admin ID (áˆˆáŠ á‹µáˆšáŠ•):</label>
                    <input type="text" id="login-identifier" required>
                </div>
                <div class="input-group">
                    <label for="login-password">á‹¨á‹­áˆˆá á‰ƒáˆ / Password:</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="submit-btn">Login</button>
                <p class="message" id="login-message"></p>
                <p style="margin-top: 20px; font-size: 14px;">
                    áˆ˜áˆˆá‹« á‹¨áˆˆá‹á‰µáˆ? 
                    <a href="#" id="go-to-register" style="color: #387c38; font-weight: bold; text-decoration: none;">áŠ¥á‹šáˆ… á‹­áˆ˜á‹áŒˆá‰¡</a>
                </p>
            </form>

            <form id="register-form" class="form-box">
                <h2>Register</h2>
                <div class="input-group">
                    <label for="register-name">áˆ™áˆ‰ áˆµáˆ / Full Name:</label>
                    <input type="text" id="register-name" required>
                </div>
                <div class="input-group">
                    <label for="register-phone">áˆµáˆáŠ­ á‰áŒ¥áˆ­ / Phone Number:</label>
                    <input type="tel" id="register-phone" required pattern="[0-9]{10,15}" title="áˆµáˆáŠ­ á‰áŒ¥áˆ­á‹áŠ• á‰ á‰µáŠ­áŠ­áˆ á‹«áˆµáŒˆá‰¡">
                </div>
                <div class="input-group">
                    <label for="register-password">á‹¨á‹­áˆˆá á‰ƒáˆ / Password (á‰¢á‹«áŠ•áˆµ 6 áŠá‹°áˆ):</label>
                    <input type="password" id="register-password" required minlength="6">
                </div>
                <div class="input-group">
                    <label for="register-confirm-password">á‹¨á‹­áˆˆá á‰ƒáˆ áˆ›áˆ¨áŒ‹áŒˆáŒ« / Confirm Password:</label>
                    <input type="password" id="register-confirm-password" required minlength="6">
                </div>
                
                <div class="input-group-half">
                    <div class="input-group">
                        <label for="register-referral">Referral Code (áŠ áˆµáˆáˆ‹áŒŠ áŠ á‹­á‹°áˆˆáˆ):</label>
                        <input type="text" id="register-referral"> 
                    </div>
                    <button type="submit" class="submit-btn submit-btn-register">Register</button>
                </div>
                
                <p class="message" id="register-message"></p>
                <p style="margin-top: 20px; font-size: 14px;">
                    áˆ˜áˆˆá‹« áŠ áˆˆá‹á‰µ? 
                    <a href="#" id="go-to-login" style="color: #387c38; font-weight: bold; text-decoration: none;">Login á‹«á‹µáˆ­áŒ‰</a>
                </p>
            </form>
        </div>
    </div>
    
    <div id="dashboard-area" class="dashboard-page">
        
        
        <div class="header">
            <h2 style="color: #1e5a2c;"><span id="user-name">áŠ¥áŠ•áŠ³áŠ• á‹°áˆ…áŠ“ áˆ˜áŒ¡! áŠ á‰¶/á‹ˆá‹­á‹˜áˆ® á‰£áˆˆáˆ€á‰¥á‰µ</span></h2>
        </div>

        <div id="home-content" class="page-content active">
            
            <div class="main-home-content" id="main-home-content-div">
                <div class="stats-grid">
                    <div class="info-card balance-card">
                        <h2>áŒ á‰…áˆ‹áˆ‹ á‰€áˆª áˆ‚áˆ³á‰¥ / Total Balance</h2>
                        <p class="amount-display">ETB <span id="current-balance">0.00</span></p> 
                        <small style="color: #00796b;">á‹­áˆ… 50 ETB á‹¨áŠ¥áˆ­áˆµá‹ á‹¨áˆ˜áˆ˜á‹áŒˆá‰¢á‹« á‰¦áŠáˆµ áŠá‹á¢</small>
                    </div>
                    <div class="info-card profit-card">
                        <h2>áŒ á‰…áˆ‹áˆ‹ á‹¨áŠ¢áŠ•á‰¨áˆµá‰µáˆ˜áŠ•á‰µ áˆ˜áŒ áŠ•</h2>
                        <p class="amount-display profit-amount-display">ETB <span id="total-invested-amount">0.00</span></p>
                        <small style="color: #ff9800;">á‹•áˆˆá‰³á‹Š á‰µáˆ­á á‹¨áˆšáˆ°áˆ‹á‹ áŠ¨áŒˆá‰£á‹ áŠ¢áŠ•á‰¨áˆµá‰µáˆ˜áŠ•á‰µ áŠá‹á¢</small>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button id="deposit-btn">ğŸ’° áŒˆáŠ•á‹˜á‰¥ áˆ›áˆµáŒˆá‰¢á‹« (Deposit)</button>
                    <button id="withdraw-btn">ğŸ’¸ áŒˆáŠ•á‹˜á‰¥ áˆ›á‹áŒ« (Withdraw)</button>
                </div>

                <div class="about-section">
                    <h3>ğŸŒ± áˆµáˆˆ áŠ áŒáˆ®-áŠ¬áˆšáŠ«áˆ áŠ¢áŠ•á‰¨áˆµá‰µáˆ˜áŠ•á‰µ áŠ¥áŠ“ áŠ á‹‹áŒ­áŠá‰±</h3>
                    <p>á‹¨ **áŠ áŒáˆ®-áŠ¬áˆšáŠ«áˆ áŠ¢áŠ•á‰¨áˆµá‰µáˆ˜áŠ•á‰µ** á‹˜áˆ­á á‰ á‹˜áˆ˜áŠ“á‹Š áŒá‰¥áˆ­áŠ“ á‹áˆµáŒ¥ á‰ áŒ£áˆ áˆáŒ£áŠ• á‹•á‹µáŒˆá‰µ áŠ¥á‹«áˆ³á‹¨ á‹«áˆˆ á‹ˆáˆ³áŠ áŠ¢áŠ•á‹±áˆµá‰µáˆª áŠá‹á¢ áˆ›á‹³á‰ áˆªá‹«á‹á‰½á£ á€áˆ¨-á‰°á‰£á‹­ áˆ˜á‹µáŠƒáŠ’á‰¶á‰½ áŠ¥áŠ“ á‹¨áŠ¥á‹µáŒˆá‰µ áˆ˜á‰†áŒ£áŒ áˆªá‹« áŠ¬áˆšáŠ«áˆá‰½ á‹¨áˆáˆ­á‰µ á‰¥áŠ­áŠá‰µáŠ• á‰ áˆ˜á‰€áŠáˆµá£ á‹¨áˆ°á‰¥áˆ áŒ¥áˆ«á‰µáŠ• á‰ áˆ›áˆ³á‹°áŒ áŠ¥áŠ“ á‹¨áˆáŒá‰¥ á‹‹áˆµá‰µáŠ“áŠ• á‰ áˆ›áˆ¨áŒ‹áŒˆáŒ¥ á‹¨á‹“áˆˆáˆ›á‰½áŠ•áŠ• á‹¨áˆáŒá‰¥ ááˆ‹áŒá‰µ áˆˆáˆ›áˆ­áŠ«á‰µ á‰áˆá áˆšáŠ“ á‹­áŒ«á‹ˆá‰³áˆ‰á¢</p>

                    <p><strong>áˆˆáˆáŠ• áŠ¢áŠ•á‰¨áˆµá‰µ áˆ›á‹µáˆ¨áŒ áŠ áˆˆá‰¥á‹á‰µ?</strong> á‹¨á‹“áˆˆáˆ áˆ•á‹á‰¥ á‰áŒ¥áˆ­ á‹•á‹µáŒˆá‰µ áŠ¥áŠ“ á‹¨áŠ á‹¨áˆ­ áŠ•á‰¥áˆ¨á‰µ áˆˆá‹áŒ¥ áˆˆáŒá‰¥áˆ­áŠ“ á‹˜áˆ­á á‹¨á‰´áŠ­áŠ–áˆáŒ‚ ááˆ‹áŒá‰µáŠ• áŒ¨áˆáˆ¯áˆá¢ á‰ á‹šáˆ…áˆ áˆáŠ­áŠ•á‹«á‰µ á‹¨áŒá‰¥áˆ­áŠ“ áŠ¬áˆšáŠ«áˆá‰½ ááˆ‹áŒá‰µ á‰ á‹¨á‹“áˆ˜á‰± áŠ¥á‹«á‹°áŒˆ áŠá‹á¢ á‹¨áŠ¥áŠ› áˆ˜á‹µáˆ¨áŠ­ á‰£áˆˆáˆ€á‰¥á‰¶á‰½áŠ• áŠ¨á‹šáˆ… á‹˜áˆ­á áŒ‹áˆ­ á‰ áˆ›áˆµá‰°áˆ³áˆ°áˆ­ áŒˆáŠ•á‹˜á‰¥á‹ á‰ á‰°áŒ¨á‰£áŒ­ áˆ¥áˆ« áˆ‹á‹­ áŠ¥áŠ•á‹²á‹áˆ á‹«á‹°áˆ­áŒ‹áˆá¢</p>
                    
                    <p><strong>á‹¨áŠ¥áŠ› áˆá‹©áŠá‰µ:</strong> áŠ¢áŠ•á‰¨áˆµá‰µáˆ˜áŠ•á‰µá‹ á‰ áŠƒáˆ‹áŠáŠá‰µ á‰ á‰°áˆáˆ‹á‰ á‰µ áˆ˜áŠ•áŒˆá‹µ á‰ á‹˜áˆ­á‰ áˆ‹á‹­ áŠ¥áŠ•á‹²á‹áˆ áŠ¥áŠ“áˆ¨áŒ‹áŒáŒ£áˆˆáŠ•á¢ áŠ¨áˆáˆ‰áˆ á‰ áˆ‹á‹­á£ áˆˆá‰£áˆˆáˆ€á‰¥á‰¶á‰»á‰½áŠ• á‰ á‹¨á‰€áŠ‘ **áŠ¨áá‰°áŠ› áŠ¥áŠ“ á‹¨á‰°áˆ¨áŒ‹áŒ‹ á‰µáˆ­á** áŠ¥áŠ•á‹²á‹«áŒˆáŠ™ á‹¨áˆšá‹«áˆµá‰½áˆ áŠ áˆµá‰°áˆ›áˆ›áŠ á‹¨áˆ˜á‹‹á‹•áˆˆ áŠ•á‹‹á‹­ áˆ˜á‹µáˆ¨áŠ­áŠ• áŠ¥áŠ•áˆáŒ¥áˆ«áˆˆáŠ•á¢ áŒˆáŠ•á‹˜á‰¥á‹ á‹áˆ á‰¥áˆ áŠ á‹­á‰€áˆ˜áŒ¥áˆá¤ á‹­áˆ áˆ«áˆ!</p>
                </div>
            </div>
            
            <div class="deposit-page-content" id="deposit-page-content-div" style="display: none;">
                <button id="back-to-home-from-deposit-btn" style="float: left; background: #f0f0f0; border: 1px solid #ccc; padding: 10px; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">ğŸ”™ á‹ˆá‹° Home á‰°áˆ˜áˆˆáˆµ</button>
                <div style="clear: both;"></div>

                <div id="deposit-form-content">
                    <h3>ğŸ’µ áŒˆáŠ•á‹˜á‰¥ áˆˆáˆ›áˆµáŒˆá‰£á‰µ á‹¨áˆšá‹«áˆµáˆáˆáŒ‰ áˆ˜áˆ¨áŒƒá‹á‰½ (Deposit)</h3>
                    
                    <div class="payment-info">
                        <p>áŒˆáŠ•á‹˜á‰¥á‹áŠ• áŠ¨á‰³á‰½ á‰ á‰°áŒ á‰€áˆ±á‰µ á‹¨áŠ­áá‹« áˆ˜áŠ•áŒˆá‹¶á‰½ áˆ‹á‹­ á‹«áˆµáŒˆá‰¡:</p>
                        <p>ğŸ¦ **CBE áŠ áŠ«á‹áŠ•á‰µ:** <strong>1000413223133</strong> (áˆµáˆ: Mikiyas)</p>
                        <p>ğŸ“± **Telebirr:** <strong>0942945499</strong> (áˆµáˆ: Mikiyas)</p>
                        <p style="margin-top: 10px; color: #ff9800; font-weight: bold;">áŒˆáŠ•á‹˜á‰¥ áŠ«áˆµáŒˆá‰¡ á‰ áŠ‹áˆ‹ **Transaction ID (á‹¨á‹á‹á‹áˆ­ á‰áŒ¥áˆ­)** áˆ˜áˆ˜á‹áŒˆá‰¥á‹áŠ• áŠ á‹­áˆ­áˆ±!</p>
                    </div>

                    <form id="deposit-form">
                        <div class="input-group">
                            <label for="deposit-amount">á‹¨áŒˆáŠ•á‹˜á‰¥ áˆ˜áŒ áŠ• (Amount) - á‰ ETB:</label>
                            <input type="number" id="deposit-amount" min="500" placeholder="á‰¢á‹«áŠ•áˆµ 500 ETB" required>
                        </div>
                        <div class="input-group">
                            <label for="transaction-id">Transaction ID (á‹¨á‹á‹á‹áˆ­ á‰áŒ¥áˆ­):</label>
                            <input type="text" id="transaction-id" placeholder="áˆˆáˆáˆ³áˆŒ: AB12345678" required>
                        </div>
                        
                        <button type="submit" id="deposit-submit-btn" class="submit-btn">âœ… Deposit áŒ¥á‹«á‰„ áŠ áˆµáŒˆá‰£</button>
                        <p class="message deposit-message" id="deposit-form-message"></p>
                    </form>
                </div>
            </div>
            
            <div class="withdraw-page-content" id="withdraw-page-content-div" style="display: none;">
                <button id="back-to-home-from-withdraw-btn" style="float: left; background: #f0f0f0; border: 1px solid #ccc; padding: 10px; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">ğŸ”™ á‹ˆá‹° Home á‰°áˆ˜áˆˆáˆµ</button>
                <div style="clear: both;"></div>

                <div id="withdraw-form-content">
                    <h3>ğŸ’¸ áŒˆáŠ•á‹˜á‰¥ áˆ›á‹áŒ« (Withdraw)</h3>
                    
                    <p style="text-align: center; color: #f44336; font-weight: bold;">á‰¢á‹«áŠ•áˆµ 100 ETB áˆ›á‹áŒ£á‰µ á‹­á‰½áˆ‹áˆ‰á¢</p>

                    <form id="withdraw-form">
                        <div class="input-group">
                            <label for="withdraw-bank-name">á‹¨á‰£áŠ•áŠ­ áˆµáˆ:</label>
                            <select id="withdraw-bank-name" required>
                                <option value="">--- á‹¨á‰£áŠ•áŠ­ áˆµáˆ á‹­áˆáˆ¨áŒ¡ ---</option>
                                <option value="CBE">Commercial Bank of Ethiopia (CBE)</option>
                                <option value="Awash">Awash Bank</option>
                                <option value="Dashen">Dashen Bank</option>
                                <option value="Abyssinia">Bank of Abyssinia</option>
                                <option value="Telebirr">Telebirr</option>
                                <option value="Other">áˆŒáˆ‹ (Other)</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label for="withdraw-full-name">á‹¨á‰£áˆˆá‰¤á‰± áˆ™áˆ‰ áˆµáˆ (Name of Account Holder):</label>
                            <input type="text" id="withdraw-full-name" placeholder="áˆ™áˆ‰ áˆµáˆ" required>
                        </div>
                        
                        <div class="input-group">
                            <label for="withdraw-account-number">á‹¨áŠ áŠ«á‹áŠ•á‰µ / áˆµáˆáŠ­ á‰áŒ¥áˆ­:</label>
                            <input type="text" id="withdraw-account-number" placeholder="á‹¨á‰£áŠ•áŠ­ áŠ áŠ«á‹áŠ•á‰µ á‰áŒ¥áˆ­ á‹ˆá‹­áˆ Telebirr á‰áŒ¥áˆ­" required>
                        </div>
                        <div class="input-group">
                            <label for="withdraw-amount">á‹¨áŒˆáŠ•á‹˜á‰¥ áˆ˜áŒ áŠ• (Amount) - á‰ ETB:</label>
                            <input type="number" id="withdraw-amount" min="100" placeholder="á‰¢á‹«áŠ•áˆµ 100 ETB" required>
                        </div>
                        
                        <button type="submit" id="withdraw-submit-btn" class="submit-btn">âœ… Withdraw áŒ¥á‹«á‰„ áŠ áˆµáŒˆá‰£</button>
                        <p class="message withdraw-message" id="withdraw-form-message"></p>
                    </form>
                </div>
            </div>
            
        </div>
        
        <div id="investment-content" class="page-content">
            <div class="investment-plans">
                <h3>ğŸ’° á‹¨áŠ¢áŠ•á‰¨áˆµá‰µáˆ˜áŠ•á‰µ á‹•á‰…á‹¶á‰½ áŠ¥áŠ“ áŒ¥á‰…áˆ› áŒ¥á‰…áˆá‰½</h3>
                
                <div class="plan-grid" id="plan-grid-list">
                    
                    <button class="plan-button" id="plan-1-btn" data-plan="Basic" data-min="500" data-max="4999" data-rate="7" data-days="40">
                        <h4>Plan 1: áˆ˜áˆ áˆ¨á‰³á‹Š (Basic)</h4>
                        <div class="plan-details">
                            <p>áˆ˜áŒ áŠ•: <strong>ETB 500 - 4,999</strong></p>
                            <p>áŒŠá‹œ: <strong>40 á‰€áŠ“á‰µ</strong></p>
                            <p class="daily-rate">á‹•áˆˆá‰³á‹Š á‰µáˆ­á: 7%</p>
                        </div>
                    </button>

                    <button class="plan-button" id="plan-2-btn" data-plan="Standard" data-min="5000" data-max="9999" data-rate="8" data-days="70">
                        <h4>Plan 2: áˆ˜áŠ«áŠ¨áˆˆáŠ› (Standard)</h4>
                        <div class="plan-details">
                            <p>áˆ˜áŒ áŠ•: <strong>ETB 5,000 - 9,999</strong></p>
                            <p>áŒŠá‹œ: <strong>70 á‰€áŠ“á‰µ</strong></p>
                            <p class="daily-rate">á‹•áˆˆá‰³á‹Š á‰µáˆ­á: 8%</p>
                        </div>
                    </button>

                    <button class="plan-button" id="plan-3-btn" data-plan="Premium" data-min="10000" data-max="1000000" data-rate="9" data-days="100">
                        <h4>Plan 3: á‹‹áŠ“ (Premium)</h4>
                        <div class="plan-details">
                            <p>áˆ˜áŒ áŠ•: <strong>ETB 10,000+</strong></p>
                            <p>áŒŠá‹œ: <strong>100 á‰€áŠ“á‰µ</strong></p>
                            <p class="daily-rate">á‹•áˆˆá‰³á‹Š á‰µáˆ­á: 9%</p>
                        </div>
                    </button>
                </div>
                
                <div class="purchase-form-box" id="purchase-form-box" style="display: none;">
                    <button id="back-to-plans-btn" style="float: right; background: #ccc; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold;">âŒ</button>
                    <h4>
                        <span id="selected-plan-name">Selected Plan</span> áŒá‹¢
                    </h4>
                    
                    <p style="text-align: center; font-size: 15px;">
                        á‹¨áŠ¥áˆ­áˆµá‹ á‰€áˆª áˆ‚áˆ³á‰¥: <strong>ETB <span id="current-balance-purchase">0.00</span></strong>
                    </p>
                    <p id="plan-info-display" style="text-align: center; color: #387c38; font-weight: bold;"></p>

                    <form id="purchase-form">
                        <div class="input-group">
                            <label for="purchase-amount">á‹¨áŠ¢áŠ•á‰¨áˆµá‰µáˆ˜áŠ•á‰µ áˆ˜áŒ áŠ• (Amount) - á‰ ETB:</label>
                            <input type="number" id="purchase-amount" required>
                        </div>
                        
                        <button type="submit" id="purchase-submit-btn" class="submit-btn">âœ… BUY / áŒá‹›</button>
                        <p class="message" id="purchase-form-message" style="text-align: center;"></p>
                    </form>
                </div>
                
                <div class="my-investments-section" style="margin-top: 40px; text-align: center;">
                    <h3>áŠ¥áˆ­áˆµá‹ á‹¨áŒˆá‹™á‹‹á‰¸á‹ áŠ¢áŠ•á‰¨áˆµá‰µáˆ˜áŠ•á‰¶á‰½</h3>
                    <div id="investment-list-display" style="border: 1px solid #ccc; border-radius: 8px; padding: 15px; background-color: white; min-height: 50px; text-align: left;">
                        <p style="text-align: center; color: #555;">áŒˆáŠ“ áˆáŠ•áˆ áŠ¢áŠ•á‰¨áˆµá‰µ áŠ áˆ‹á‹°áˆ¨áŒ‰áˆá¢</p>
                    </div>
                </div>

            </div>
        </div>
        
        <div id="account-content" class="page-content other-page">
            <h3>ğŸ‘¤ á‹¨áŠ” áˆ˜áˆˆá‹« (My Account)</h3>
            <div class="account-details">
                <p>á‹­áˆ… áŒˆáŒ½ á‹¨áŠ¥áˆ­áˆµá‹áŠ• á‹¨áŒáˆ áˆ˜áˆ¨áŒƒá‹á‰½ (áˆµáˆáŠ­ á‰áŒ¥áˆ­á£ á‹¨á‹­áˆˆá á‰ƒáˆ áˆ˜á‰€á‹¨áˆ­á‹« á‹ˆá‹˜á‰°) á‹­á‹­á‹›áˆá¢</p>
                <p><strong>á‹¨áˆ˜áˆˆá‹« áˆ˜áˆ¨áŒƒá¡</strong> <span id="account-info">áˆµáˆáŠ­: ... | áˆ™áˆ‰ áˆµáˆ: ...</span></p>
            </div>
            
            <div class="account-buttons">
                
                <button id="customer-service-btn" type="button">ğŸ“ Customer Service (á‹¨á‹°áŠ•á‰ áŠ› áŠ áŒˆáˆáŒáˆá‰µ)</button>

                <button id="transaction-history-btn" type="button">ğŸ§¾ Transaction History (á‹¨á‹á‹á‹áˆ­ á‰³áˆªáŠ­)</button>

                <button id="change-password-btn" type="button">ğŸ”‘ á‹¨á‹­áˆˆá á‰ƒáˆ á‰€á‹­áˆ­ (Change Password)</button>
                
                <button id="logout-btn-account" type="button">ğŸšª Logout (á‹áŒ£)</button>
            </div>
            <p class="message" id="history-message" style="margin-top: 20px; text-align: center;"></p>
        </div>
        
        <div id="team-content" class="page-content other-page">
            <h3>ğŸ‘¥ My Team (á‹¨áˆªáˆáˆ«áˆ áŒˆáŒ½)</h3>
            
            <div class="referral-box">
                <h4>ğŸ‰ áŒ“á‹°áŠ›á‹áŠ• á‹­áŒ‹á‰¥á‹™ áŠ¥áŠ“ á‰°áŒ¨áˆ›áˆª áŒˆá‰¢ á‹«áŒáŠ™!</h4>
                <p>á‹¨áŠ¥áˆ­áˆµá‹áŠ• **Referral Code** á‹ˆá‹­áˆ **Login Link** á‰°áŒ á‰…áˆ˜á‹ áŒ“á‹°áŠ›á‹áŠ• á‹«áˆµáˆ˜á‹áŒá‰¡á¢</p>
                
                <div style="margin-bottom: 20px;">
                    <strong style="color: #555;">á‹¨áŠ¥áˆ­áˆµá‹ Referral Code:</strong>
                    <div class="referral-info">
                        <span id="referral-code-display" class="referral-code-display">...</span>
                        <button id="copy-code-btn" class="copy-btn">á‰…á‹³</button>
                    </div>
                </div>

                <div>
                    <strong style="color: #555;">á‹¨áŠ¥áˆ­áˆµá‹ á‹¨áˆ˜áˆ˜á‹áŒˆá‰¢á‹« áˆŠáŠ•áŠ­:</strong>
                    <div class="referral-info">
                        <span id="referral-link-display" class="referral-link-display">...</span>
                        <button id="copy-link-btn" class="copy-btn">á‰…á‹³</button>
                    </div>
                </div>
                
                <p style="margin-top: 20px; font-weight: bold;">áŒ á‰…áˆ‹áˆ‹ á‰¡á‹µáŠ• áŠ á‰£áˆ‹á‰µ: <span id="team-size-display">0</span></p>
            </div>
            
            <div class="commission-rules">
                <h4>ğŸ“œ á‹¨áˆªáˆáˆ«áˆ áŠ®áˆšáˆ½áŠ• áˆ…áŒ</h4>
                <p>âœ… **á‹¨áˆ˜áŒ€áˆ˜áˆªá‹« áŒ‹á‰£á‹¥ á‰¦áŠáˆµ (Level 1 Bonus):** á‰ áˆªáˆáˆ«áˆ áˆŠáŠ•áŠ­á‹ á‹¨á‰°áˆ˜á‹˜áŒˆá‰  áˆ°á‹ á‰ áŠ«á’á‰³áˆ áŠ¢áŠ•á‰¨áˆµá‰µ áˆ²áŒ€áˆáˆ­ **80 ETB** á‹ˆá‹²á‹«á‹áŠ‘ á‹ˆá‹° áŠ áŠ«á‹áŠ•á‰µá‹ áŒˆá‰¢ á‹­á‹°áˆ¨áŒ‹áˆá¢</p>
                <p>ğŸ“ˆ **á‹¨á‹•áˆˆá‰³á‹Š á‰µáˆ­á áŠ®áˆšáˆ½áŠ•:** á‰ áˆ­áˆµá‹ á‹¨á‰°áŒ‹á‰ á‹˜á‹ áˆ°á‹ (Level 1) á‰ á‹¨á‰€áŠ‘ áŠ¨áˆšá‹«áŒˆáŠ˜á‹ á‰µáˆ­á áˆ‹á‹­ **20%** á‹­áˆ°áŒ¥á‹á‰³áˆá¢</p>
                <p style="margin-top: 10px; font-weight: bold; color: #1e5a2c;">á‹­áˆ… á‰µáˆ­á á‹¨áŒ“á‹°áŠ›á‹áŠ• á‰µáˆ­á áˆ³á‹­áŠáŠ« á‰ á‰°áŠ“áŒ áˆ áŠ¨áŠ©á‰£áŠ•á‹«á‹ á‹¨áˆšáˆ°áŒ¥ áŠá‹á¢</p>
            </div>

        </div>

        <div class="bottom-navbar">
            <button id="nav-home" class="nav-active">Home</button>
            <button id="nav-investment">Investment</button>
            <button id="nav-account">á‹¨áŠ” áˆ˜áˆˆá‹«</button>
            <button id="nav-team">My Team</button>
        </div>

    </div>
    
    <div id="admin-dashboard-area" class="admin-dashboard-page">
        <div class="admin-header">
            <h2>ğŸ” Admin Panel</h2>
            <p>á‹¨á‰°áŒ á‰ƒáˆšá‹á‰½áŠ• Deposit áŠ¥áŠ“ Withdraw áŒ¥á‹«á‰„á‹á‰½ áŠ¥á‹šáˆ… á‹«áˆ¨áŒ‹áŒáŒ¡á¢</p>
        </div>

        <div class="admin-transaction-list">
            <h3>ğŸ“‘ á‰ áˆ˜áŒ á‰£á‰ á‰… áˆ‹á‹­ á‹«áˆ‰ áŒ¥á‹«á‰„á‹á‰½ (Pending Requests)</h3>
            <p id="admin-message" style="color: #f44336; font-weight: bold;"></p>
            <div id="pending-transactions-list">
                <p style="text-align: center; color: #555;">áˆáŠ•áˆ á‰ áˆ˜áŒ á‰£á‰ á‰… áˆ‹á‹­ á‹«áˆˆ áŒ¥á‹«á‰„ á‹¨áˆˆáˆá¢</p>
            </div>
        </div>
        
        <button id="admin-logout-btn" class="admin-logout-btn">ğŸšª áŠ¨áŠ á‹µáˆšáŠ• á‹áŒ£ (Logout)</button>
    </div>
    
    <script>
        // ********** 1. FIREBASE INITIALIZATION **********
        const firebaseConfig = {
            apiKey: "AIzaSyDu7AqPVMcvSR-hA6VO7zfVCd9XhJvQFcs",
            authDomain: "mmmm-c2cc3.firebaseapp.com",
            databaseURL: "https://mmmm-c2cc3-default-rtdb.firebaseio.com",
            projectId: "mmmm-c2cc3",
            storageBucket: "mmmm-c2cc3.firebasestorage.app",
            messagingSenderId: "1064370711409",
            appId: "1:1064370711409:web:05787d6231bc721c6aa4d0",
            measurementId: "G-MZ7FM1D607"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const usersRef = database.ref('users');
        
        // ********** 2. GLOBAL STATE AND ADMIN INFO **********
        let activeUser = null; // Currently logged-in user data
        let isAdmin = false; 
        const adminCredentials = { identifier: 'admin', password: 'admin123' }; // Admin Info
        let selectedPlan = null;
        
        // ********** 3. DOM ELEMENTS **********
        // Area Containers
        const loginRegisterArea = document.getElementById('login-register-area');
        const dashboardArea = document.getElementById('dashboard-area');
        const adminDashboardArea = document.getElementById('admin-dashboard-area');
        
        // Dashboard Stats
        const userNameDisplay = document.getElementById('user-name');
        const currentBalanceDisplay = document.getElementById('current-balance');
        const totalInvestedAmountDisplay = document.getElementById('total-invested-amount');
        const currentBalancePurchaseDisplay = document.getElementById('current-balance-purchase');
        
        // Navigation Buttons
        const navHome = document.getElementById('nav-home');
        const navInvestment = document.getElementById('nav-investment');
        const navAccount = document.getElementById('nav-account');
        const navTeam = document.getElementById('nav-team');
        const allNavButtons = [navHome, navInvestment, navAccount, navTeam];
        
        // Dashboard Content Sections
        const homeContent = document.getElementById('home-content');
        const investmentContent = document.getElementById('investment-content');
        const accountContent = document.getElementById('account-content');
        const teamContent = document.getElementById('team-content');
        const allContentSections = [homeContent, investmentContent, accountContent, teamContent];
        
        // Home page sub-sections
        const mainHomeContentDiv = document.getElementById('main-home-content-div');
        const depositPageContentDiv = document.getElementById('deposit-page-content-div');
        const withdrawPageContentDiv = document.getElementById('withdraw-page-content-div');
        
        // Deposit/Withdraw elements
        const depositBtn = document.getElementById('deposit-btn');
        const backToHomeFromDepositBtn = document.getElementById('back-to-home-from-deposit-btn');
        const depositForm = document.getElementById('deposit-form');
        const depositFormMessage = document.getElementById('deposit-form-message');
        const depositAmountInput = document.getElementById('deposit-amount');
        const transactionIdInput = document.getElementById('transaction-id');
        
        const withdrawBtn = document.getElementById('withdraw-btn');
        const backToHomeFromWithdrawBtn = document.getElementById('back-to-home-from-withdraw-btn');
        const withdrawForm = document.getElementById('withdraw-form');
        const withdrawFormMessage = document.getElementById('withdraw-form-message');
        const withdrawAmountInput = document.getElementById('withdraw-amount');
        const withdrawBankNameInput = document.getElementById('withdraw-bank-name');
        const withdrawAccountNumberInput = document.getElementById('withdraw-account-number');
        const withdrawFullNameInput = document.getElementById('withdraw-full-name');
        
        // Investment elements
        const planButtons = document.querySelectorAll('.plan-button');
        const planGridList = document.getElementById('plan-grid-list');
        const purchaseFormBox = document.getElementById('purchase-form-box');
        const backToPlansBtn = document.getElementById('back-to-plans-btn');
        const selectedPlanNameDisplay = document.getElementById('selected-plan-name');
        const planInfoDisplay = document.getElementById('plan-info-display');
        const purchaseAmountInput = document.getElementById('purchase-amount');
        const purchaseForm = document.getElementById('purchase-form');
        const purchaseFormMessage = document.getElementById('purchase-form-message');
        const investmentListDisplay = document.getElementById('investment-list-display');

        // My Team elements
        const referralCodeDisplay = document.getElementById('referral-code-display');
        const referralLinkDisplay = document.getElementById('referral-link-display');
        const copyCodeBtn = document.getElementById('copy-code-btn');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const teamSizeDisplay = document.getElementById('team-size-display');
        
        // Login/Register elements
        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginMessage = document.getElementById('login-message');
        const registerMessage = document.getElementById('register-message');
        const goToRegisterLink = document.getElementById('go-to-register');
        const goToLoginLink = document.getElementById('go-to-login');
        
        // Admin Panel elements
        const pendingTransactionsList = document.getElementById('pending-transactions-list');
        const adminMessage = document.getElementById('admin-message');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        
        // Account buttons
        const changePasswordBtn = document.getElementById('change-password-btn');
        const transactionHistoryBtn = document.getElementById('transaction-history-btn');
        const logoutBtnAccount = document.getElementById('logout-btn-account');
        const historyMessage = document.getElementById('history-message');

        // ********** 4. UTILITY FUNCTIONS **********
        
        // Helper to generate a simple referral code
        function generateReferralCode(phone) {
            return 'AGR' + phone.slice(-4) + Math.random().toString(36).substr(2, 3).toUpperCase();
        }

        // Helper to get all users data from DB (async operation)
        async function getAllUsersData() {
            const snapshot = await usersRef.once('value');
            return snapshot.val() || {}; // Returns an object of users
        }

        // Helper to get user data (for activeUser or another user)
        async function getUserData(identifier) {
            const snapshot = await usersRef.child(identifier).once('value');
            return snapshot.val();
        }

        // Helper to update a user's data
        function updateUserData(identifier, userData) {
            // Firebase Realtime DB cannot store empty arrays/objects, so convert empty transactions/investments to object or remove them
            if (userData.transactions && userData.transactions.length === 0) {
                userData.transactions = null; // Removing null keys is cleaner
            }
            if (userData.investments && userData.investments.length === 0) {
                userData.investments = null;
            }

            return usersRef.child(identifier).update(userData);
        }


        // ***** UTILITY FUNCTION: Login/Register Tab áˆ˜á‰€á‹«á‹¨áˆ­á‹« *****
        function switchAuthTab(tabName) {
            loginTab.classList.remove('active');
            registerTab.classList.remove('active');
            loginForm.classList.remove('active');
            registerForm.classList.remove('active');

            loginMessage.textContent = '';
            registerMessage.textContent = '';

            if (tabName === 'login') {
                loginTab.classList.add('active');
                loginForm.classList.add('active');
            } else if (tabName === 'register') {
                registerTab.classList.add('active');
                registerForm.classList.add('active');
            }
        }

        // ***** Dashboard áŒˆáŒ½ á‹¨áˆ˜á‰€á‹«á‹¨áˆ­ á‰°áŒá‰£áˆ­ *****
        function switchDashboardPage(pageId) {
            allContentSections.forEach(section => section.classList.remove('active'));
            allNavButtons.forEach(button => button.classList.remove('nav-active'));

            mainHomeContentDiv.style.display = 'block';
            depositPageContentDiv.style.display = 'none';
            withdrawPageContentDiv.style.display = 'none';
            purchaseFormBox.style.display = 'none';
            planGridList.style.display = 'flex';
            historyMessage.textContent = ''; // á‹¨ Transaction History áˆ˜áˆá‹•áŠ­á‰µáŠ• á‹«áŒ á‹áˆ

            let targetSection, targetNav;
            switch (pageId) {
                case 'home':
                    targetSection = homeContent;
                    targetNav = navHome;
                    break;
                case 'investment':
                    targetSection = investmentContent;
                    targetNav = navInvestment;
                    displayInvestments();
                    break;
                case 'account':
                    targetSection = accountContent;
                    targetNav = navAccount;
                    document.getElementById('account-info').textContent = `áˆµáˆáŠ­: ${activeUser.identifier} | áˆ™áˆ‰ áˆµáˆ: ${activeUser.name}`;
                    break;
                case 'team':
                    targetSection = teamContent;
                    targetNav = navTeam;
                    updateTeamData();
                    break;
            }

            if (targetSection) {
                targetSection.classList.add('active');
                targetNav.classList.add('nav-active');
            }
        }

        // ***** Dashboard á‹³á‰³ áˆ›áˆ³á‹«/áˆ›á‹˜áˆ˜áŠ• á‰°áŒá‰£áˆ­ *****
        async function updateDashboardData() {
            if (!activeUser) return;
            
            // 1. á‹¨á‰µáˆ­á áˆµáˆŒá‰µ (Profit Simulation)
            await simulateDailyProfit(activeUser.identifier);

            // 2. á‹¨á‰°áˆ»áˆ»áˆˆá‹áŠ• á‹¨á‰°áŒ á‰ƒáˆš áˆ˜áˆ¨áŒƒ áŠ¨ DB áˆ›á‹áŒ£á‰µ
            activeUser = await getUserData(activeUser.identifier);
            if (!activeUser) return logout(); // User somehow deleted

            // 3. UI Update
            userNameDisplay.textContent = `áŠ¥áŠ•áŠ³áŠ• á‹°áˆ…áŠ“ áˆ˜áŒ¡! ${activeUser.name}`;
            const balance = activeUser.balance ? activeUser.balance.toFixed(2) : '0.00';
            const totalInvested = activeUser.totalInvested ? activeUser.totalInvested.toFixed(2) : '0.00';

            currentBalanceDisplay.textContent = balance;
            currentBalancePurchaseDisplay.textContent = balance;
            totalInvestedAmountDisplay.textContent = totalInvested;

            // áˆªáˆáˆ«áˆ áŠ®á‹±áŠ• áˆ›áˆ³á‹¨á‰µ
            referralCodeDisplay.textContent = activeUser.referralCode;
            referralLinkDisplay.textContent = `http://agrocheminvest.com/register?ref=${activeUser.referralCode}`;
            
            // áŠ¢áŠ•á‰¨áˆµá‰µáˆ˜áŠ•á‰¶á‰½áŠ• áˆ›áˆ³á‹¨á‰µ
            displayInvestments();
        }

        // ***** á‹¨áŠ¢áŠ•á‰¨áˆµá‰µáˆ˜áŠ•á‰µ áˆ›áˆ³á‹« *****
        function displayInvestments() {
            if (!activeUser || !activeUser.investments || activeUser.investments.length === 0) {
                investmentListDisplay.innerHTML = '<p style="text-align: center; color: #555;">áŒˆáŠ“ áˆáŠ•áˆ áŠ¢áŠ•á‰¨áˆµá‰µ áŠ áˆ‹á‹°áˆ¨áŒ‰áˆá¢</p>';
                return;
            }

            let listHTML = '';
            // Investment arrayáŠ• áŠ¨ DB áˆµáŠ“áˆ˜áŒ£ Array áˆ‹á‹­áˆ†áŠ• á‹­á‰½áˆ‹áˆ (object áˆŠáˆ†áŠ• á‹­á‰½áˆ‹áˆ). á‹ˆá‹° Array áˆ˜áˆˆá‹ˆáŒ¥
            const investmentsArray = Array.isArray(activeUser.investments) ? activeUser.investments : Object.values(activeUser.investments);
            
            investmentsArray.forEach((inv) => {
                const dailyProfit = (inv.amount * inv.rate / 100).toFixed(2);
                const statusColor = inv.daysLeft > 0 ? 'green' : '#f44336';
                const statusText = inv.daysLeft > 0 ? 'Active' : 'Expired';
                listHTML += `
                    <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 8px; background-color: #f7f7f7;">
                        <p style="margin: 0;"><strong>${inv.name} Plan - ${inv.amount.toFixed(2)} ETB</strong></p>
                        <p style="margin: 3px 0; font-size: 14px;">
                            <span style="color: #387c38;">á‹•áˆˆá‰³á‹Š á‰µáˆ­á: ${dailyProfit} ETB (${inv.rate}%)</span> | á‹¨á‰°áŒˆáŠ˜ áŒ á‰…áˆ‹áˆ‹ á‰µáˆ­á: ${inv.profitEarned.toFixed(2)} ETB 
                        </p>
                        <p style="margin: 3px 0; font-size: 12px; color: #777;">
                            á‹¨áˆšá‰†á‹­á‰ á‰µ á‰€áŠ“á‰µ: <span style="font-weight: bold;">${inv.daysLeft} á‰€áŠ“á‰µ á‹­á‰€áˆ«áˆ‰</span> | áˆáŠ”á‰³: <span style="font-weight: bold; color: ${statusColor};">${statusText}</span>
                        </p>
                    </div>
                `;
            });
            investmentListDisplay.innerHTML = listHTML;
        }


        // ***** á‹•áˆˆá‰³á‹Š á‹¨á‰µáˆ­á áˆµáˆŒá‰µ (Daily Profit Simulation) *****
        async function simulateDailyProfit(userId) {
            const user = await getUserData(userId);
            if (!user || user.investments === null) {
                // áˆˆá‰°áŒ á‰ƒáˆšá‹ á‹¨á‰…áˆ­á‰¥ áŒŠá‹œ á‹¨á‰µáˆ­á áˆµáˆŒá‰µ á‰€áŠ• áˆ›á‹˜áˆ˜áŠ•
                if (user) {
                    user.lastProfitDate = new Date().toISOString().slice(0, 10);
                    await updateUserData(userId, user);
                }
                return;
            }

            const today = new Date();
            const lastDate = new Date(user.lastProfitDate || '2020-01-01'); // áˆˆáˆ˜áŒ€áˆ˜áˆªá‹« áŒŠá‹œ áˆá‹µ áˆ²á‹°áˆ¨áŒ
            
            // á‹¨10 á‰€áŠ• Simulation áŒˆá‹°á‰¥ - á‰ á‰€áŠ“á‰µ áˆ˜áŠ«áŠ¨áˆ á‹«áˆˆá‹áŠ• áˆá‹©áŠá‰µ áˆ›áˆµáˆ‹á‰µ
            const diffTime = Math.abs(today - lastDate);
            let diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 
            
            if (diffDays === 0) {
                return;
            }
            
            // á‰µáˆ­á á‹¨áˆšáˆ°áˆ‹á‹ á‰¢á‰ á‹› áˆˆ 10 á‰€áŠ“á‰µ á‰¥á‰» áŠá‹ (Simulation Limit)
            diffDays = Math.min(diffDays, 10); 
            
            let totalProfit = 0;
            const investmentsArray = Array.isArray(user.investments) ? user.investments : Object.values(user.investments);

            investmentsArray.forEach(inv => {
                if (inv.daysLeft > 0) {
                    const dailyProfit = inv.amount * (inv.rate / 100);
                    
                    let daysToDeduct = diffDays;
                    if (inv.daysLeft < diffDays) {
                        daysToDeduct = inv.daysLeft;
                    }
                    
                    const profitToAdd = dailyProfit * daysToDeduct;
                    totalProfit += profitToAdd;
                    
                    inv.profitEarned += profitToAdd;
                    inv.daysLeft -= daysToDeduct;
                    if (inv.daysLeft < 0) { inv.daysLeft = 0; }
                }
            });

            // á‹¨ Level 1 áˆªáˆáˆ«áˆ áŠ®áˆšáˆ½áŠ• áˆ›áˆµáˆ‹á‰µ
            let referralCommission = 0;
            const level1Users = users.filter(user => user.referredBy === activeUser.identifier);

            level1Users.forEach(refUser => {
                // á‰ á‰°áŒ‹á‰£á‹¡ áˆ‹á‹­ á‹¨á‹•áˆˆá‰³á‹Š á‰µáˆ­á áˆ›áˆµáˆ‹á‰µ/áˆ›áˆµáˆ˜áˆ°áˆ (áˆˆáˆ˜áŒ€áˆ˜áˆªá‹« áŒŠá‹œ á‰¥á‰»)
                // áˆ›áˆµá‰³á‹ˆáˆ»: á‹­áˆ… recursion (á‰°á‹°áŒ‹áŒ‹áˆš áŒ¥áˆª) áŠ¨á‰£á‹µ áˆŠáˆ†áŠ• á‹­á‰½áˆ‹áˆá¢ áˆˆá‰€áˆˆáˆˆ áŠ áˆ°áˆ«áˆ­ á‹¨á‰°áŒ‹á‰£á‹¡áŠ• á‰µáˆ«áŠ•á‹›áŠ­áˆ½áŠ• áˆ˜áˆ˜áˆáŠ¨á‰µ á‹­áˆ˜áŠ¨áˆ«áˆá¢
                // áˆˆá‹šáˆ… áˆáˆ³áˆŒ áŒáŠ• á‰€áŒ¥áˆ á‰£áˆˆá‹ áŠ®á‹µ áŠ¥áŠ•á‹²áˆ°áˆ« áŠ¥áŠ“á‹µáˆ­áŒˆá‹
                // simulateDailyProfit(refUser); // áˆˆá‰°áŒ‹á‰£á‹¡ á‰µáˆ­á áˆ˜áˆ áˆ«á‰µ áŠ áˆˆá‰ á‰µ
                
                // á‹¨á‰°áŒ‹á‰£á‹¡áŠ• á‰µáˆ­á áˆ›áŒáŠ˜á‰µ (á‰ á‰°áŒ‹á‰£á‹¡ áˆ‹á‹­ á‹«áˆˆá‹áŠ• transaction áˆ›á‹¨á‰µ)
                const refUserProfits = refUser.transactions.filter(t => t.type.startsWith('Profit'));
                
                if (refUserProfits.length > 0) {
                    // á‹¨á‰°áŒ‹á‰£á‹¡áŠ• á‹¨á‰…áˆ­á‰¥ áŒŠá‹œ á‰µáˆ­á áˆ˜á‹áˆ°á‹µ
                    const latestProfitTx = refUserProfits[refUserProfits.length - 1];
                    // á‹«áŒˆáŠ˜á‹ á‰µáˆ­á á‰ á‹›áˆ¬á‹ á‰€áŠ• (á‹ˆá‹­áˆ á‰  Simulation á‰€áŠ•) áˆ‹á‹­ á‹¨á‰°áˆáŒ áˆ¨ áŠ¨áˆ†áŠ áŠ®áˆšáˆ½áŠ‘áŠ• áˆ˜á‹áˆ°á‹µ
                    if (latestProfitTx.date === today.toISOString().slice(0, 10)) {
                         const profit = latestProfitTx.amount;
                         const commission = profit * 0.20; // 20% áŠ®áˆšáˆ½áŠ•
                         referralCommission += commission;
                         profitMessage += `Referral Commission from ${refUser.name}: ${commission.toFixed(2)} ETB | `;
                    }
                }
            });

            // áŠ á‹²áˆµ á‰µáˆ«áŠ•á‹›áŠ­áˆ½áŠ• áˆ˜ááŒ áˆ­ áŠ¥áŠ“ áˆ›á‹˜áˆ˜áŠ•
            if (totalProfit > 0) {
                user.balance = (user.balance || 0) + totalProfit;
                const newTx = {
                    id: 'Profit_' + Date.now(), 
                    type: "Daily Profit",
                    amount: totalProfit,
                    date: today.toISOString().slice(0, 10),
                    status: "Completed",
                    details: `Profit for ${diffDays} days`
                };
                
                // Transactions Array áˆ‹á‹­ áˆ˜áŒ¨áˆ˜áˆ­ (áŠ¨ Object.values á‹¨áˆ˜áŒ£ áŠ¨áˆ†áŠ á‹ˆá‹° Array áˆ˜á‰€á‹¨áˆ­)
                let transactionsArray = Array.isArray(user.transactions) ? user.transactions : (user.transactions ? Object.values(user.transactions) : []);
                transactionsArray.push(newTx);
                user.transactions = transactionsArray;

                // Investment Array áˆ‹á‹­ áˆ˜áŒ¨áˆ˜áˆ­
                user.investments = investmentsArray;

                // á‹¨á‰…áˆ­á‰¥ áŒŠá‹œ á‹¨á‰µáˆ­á áˆµáˆŒá‰µ á‰€áŠ• áˆ›á‹˜áˆ˜áŠ•
                user.lastProfitDate = today.toISOString().slice(0, 10);
                
                // á‹ˆá‹° Firebase Database áˆ˜áˆ‹áŠ­
                await updateUserData(userId, user);
            }
        }
        
        // ***** á‹¨áˆªáˆáˆ«áˆ á‰¡á‹µáŠ• áˆ˜áŒ áŠ• áˆ›áˆ³á‹« *****
        async function updateTeamData() {
            if (!activeUser) return;
            const allUsers = await getAllUsersData();
            const allUsersArray = Object.values(allUsers);
            const level1Users = allUsersArray.filter(refUser => refUser.referredBy === activeUser.identifier);
            
            activeUser.teamSize = level1Users.length; // DB áˆ‹á‹­ á‹¨áˆ›á‹«áˆµáˆáˆáŒ á‰¢áˆ†áŠ•áˆ áˆˆáŒŠá‹œá‹
            teamSizeDisplay.textContent = level1Users.length;
        }

        // ********** 5. EVENT HANDLERS - CORE **********

        // ***** 5.1. Login áŠ á‹«á‹«á‹ *****
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const identifier = document.getElementById('login-identifier').value.trim();
            const password = document.getElementById('login-password').value;
            loginMessage.textContent = '';
            loginMessage.classList.remove('success', 'error');

            if (identifier === adminCredentials.identifier && password === adminCredentials.password) {
                isAdmin = true;
                loginMessage.textContent = 'âœ… á‰ á‰°áˆ³áŠ« áˆáŠ”á‰³ á‹ˆá‹° áŠ á‹µáˆšáŠ• áŒˆá‰¥á‰°á‹‹áˆ!';
                loginMessage.classList.add('success');
                setTimeout(() => {
                    loginRegisterArea.style.display = 'none';
                    dashboardArea.style.display = 'none';
                    adminDashboardArea.style.display = 'block';
                    displayPendingTransactions(); // á‹¨áŠ á‹µáˆšáŠ• á“áŠáˆáŠ• á‰ áˆ˜áˆ¨áŒƒ áˆ˜áˆ™áˆ‹á‰µ
                    loginForm.reset();
                }, 1000);
                return;
            }

            // User Login
            const userData = await getUserData(identifier);

            if (userData) {
                if (userData.password === password) {
                    activeUser = userData;
                    isAdmin = false;
                    
                    loginMessage.textContent = 'âœ… á‰ á‰°áˆ³áŠ« áˆáŠ”á‰³ áŒˆá‰¥á‰°á‹‹áˆ!';
                    loginMessage.classList.add('success');
                    
                    setTimeout(() => {
                        loginRegisterArea.style.display = 'none';
                        dashboardArea.style.display = 'block';
                        adminDashboardArea.style.display = 'none';
                        updateDashboardData(); // á‹³áˆ½á‰¦áˆ­á‹±áŠ• á‰ áˆ˜áˆ¨áŒƒ á‹«á‹˜áˆáŠ“áˆ
                        switchDashboardPage('home'); // á‹ˆá‹° Home áŒˆáŒ½ á‹­á‹ˆáˆµá‹³áˆ
                        loginForm.reset();
                    }, 1000);
                } else {
                    loginMessage.textContent = 'âš ï¸ áˆµáˆáŠ­ á‰áŒ¥áˆ­ á‹ˆá‹­áˆ á‹¨á‹­áˆˆá á‰ƒáˆ á‹¨á‰°áˆ³áˆ³á‰° áŠá‹!';
                    loginMessage.classList.add('error');
                }
            } else {
                loginMessage.textContent = 'âš ï¸ áˆµáˆáŠ­ á‰áŒ¥áˆ­ á‹ˆá‹­áˆ á‹¨á‹­áˆˆá á‰ƒáˆ á‹¨á‰°áˆ³áˆ³á‰° áŠá‹!';
                loginMessage.classList.add('error');
            }
        });

        // ***** 5.2. Register áŠ á‹«á‹«á‹ *****
        registerForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('register-name').value.trim();
            const phone = document.getElementById('register-phone').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const referralCode = document.getElementById('register-referral').value.trim();
            registerMessage.textContent = '';
            registerMessage.classList.remove('success', 'error');

            if (password !== confirmPassword) {
                registerMessage.textContent = 'âš ï¸ á‹¨á‹­áˆˆá á‰ƒáˆá‰¹ áŠ á‹­áˆ˜áˆ³áˆ°áˆ‰áˆ!';
                registerMessage.classList.add('error');
                return;
            }
            
            // Check if phone number already exists in DB
            const existingUser = await getUserData(phone);
            if (existingUser) {
                registerMessage.textContent = 'âš ï¸ á‹­áŠ¸á‹ áˆµáˆáŠ­ á‰áŒ¥áˆ­ á‰€á‹°áˆ á‰¥áˆ á‰°áˆ˜á‹áŒá‰§áˆá¢ Login á‹«á‹µáˆ­áŒ‰á¢';
                registerMessage.classList.add('error');
                return;
            }

            // á‹¨áˆªáˆáˆ«áˆ áŠ®á‹±áŠ• áˆ›áˆ¨áŒ‹áŒˆáŒ« (áŠ«áˆµáˆáˆˆáŒˆ)
            let referredBy = null;
            if (referralCode) {
                const allUsers = await getAllUsersData();
                const referringUserKey = Object.keys(allUsers).find(key => allUsers[key].referralCode === referralCode);
                
                if (referringUserKey) {
                    referredBy = referringUserKey; // Key is the phone number (identifier)
                } else {
                    registerMessage.textContent = 'âš ï¸ á‹¨áˆªáˆáˆ«áˆ áŠ®á‹± á‹¨á‰°áˆ³áˆ³á‰° áŠá‹!';
                    registerMessage.classList.add('error');
                    return;
                }
            }

            const newUser = {
                name: name,
                identifier: phone,
                password: password,
                balance: 50.00, // 50 ETB Bonus
                totalInvested: 0.00,
                referralCode: generateReferralCode(phone),
                teamSize: 0,
                transactions: [
                    { id: 'tx_bonus_' + Date.now(), type: "Signup Bonus", amount: 50.00, date: new Date().toISOString().slice(0, 10), status: "Completed" }
                ],
                investments: [],
                referredBy: referredBy, // áˆªáˆáˆ­ á‹«á‹°áˆ¨áŒˆá‹ áˆ°á‹ ID
                lastProfitDate: new Date().toISOString().slice(0, 10)
            };
            
            try {
                // Save new user to Firebase using phone number as the key
                await usersRef.child(phone).set(newUser);

                registerMessage.textContent = 'âœ… á‹¨áˆá‹áŒˆá‰£ áˆ‚á‹°á‰± á‰°áˆ³áŠ­á‰·áˆá¢ áŠ áˆáŠ• Login áˆ›á‹µáˆ¨áŒ á‹­á‰½áˆ‹áˆ‰!';
                registerMessage.classList.add('success');
                registerForm.reset();
                
                // á‹ˆá‹° Login áŒˆáŒ½ áˆ˜á‰€á‹¨áˆ­
                setTimeout(() => switchAuthTab('login'), 2000);

            } catch (error) {
                console.error("Firebase registration failed:", error);
                registerMessage.textContent = 'âš ï¸ áˆá‹áŒˆá‰£á‹ áŠ áˆá‰°áˆ³áŠ«áˆá¢ áŠ¥á‰£áŠ­á‹ áŠ¥áŠ•á‹°áŒˆáŠ“ á‹­áˆáŠ­áˆ©á¢';
                registerMessage.classList.add('error');
            }
        });


        // ********** 6. EVENT HANDLERS - DASHBOARD **********

        // ***** 6.1. Deposit áŠ á‹«á‹«á‹ *****
        depositBtn.addEventListener('click', () => {
            mainHomeContentDiv.style.display = 'none';
            depositPageContentDiv.style.display = 'block';
            withdrawPageContentDiv.style.display = 'none';
            depositFormMessage.textContent = '';
            depositForm.reset();
        });

        backToHomeFromDepositBtn.addEventListener('click', () => {
            mainHomeContentDiv.style.display = 'block';
            depositPageContentDiv.style.display = 'none';
            depositFormMessage.textContent = '';
        });

        depositForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!activeUser) return logout();

            const amount = parseFloat(depositAmountInput.value);
            const txId = transactionIdInput.value.trim();
            depositFormMessage.textContent = '';
            depositFormMessage.classList.remove('success', 'error');

            if (amount < 500) {
                depositFormMessage.textContent = 'âš ï¸ á‹¨áŒˆá‰£á‹ áˆ˜áŒ áŠ• áŠ¨á‹á‰…á‰°áŠ›á‹ á‹¨ 500 ETB áŒˆá‹°á‰¥ á‹«áŠáˆ° áŠá‹á¢';
                depositFormMessage.classList.add('error');
                return;
            }
            if (txId.length < 5) {
                depositFormMessage.textContent = 'âš ï¸ Transaction ID á‰¢á‹«áŠ•áˆµ 5 áŠá‹°áˆ‹á‰µ áˆ˜áˆ†áŠ• áŠ áˆˆá‰ á‰µ!';
                depositFormMessage.classList.add('error');
                return;
            }

            // Check if TxId is already used (by checking all users in DB)
            const allUsers = await getAllUsersData();
            const allUsersArray = Object.values(allUsers);
            const isTxIdUsed = allUsersArray.some(user => 
                Array.isArray(user.transactions) && user.transactions.some(t => t.id === txId && t.type === "Deposit" && t.status !== "Rejected")
            );

            if (isTxIdUsed) {
                depositFormMessage.textContent = 'âš ï¸ á‹­áˆ… Transaction ID á‰€á‹°áˆ á‰¥áˆ áŒ¥á‰…áˆ áˆ‹á‹­ á‹áˆáˆ!';
                depositFormMessage.classList.add('error');
                return;
            }

            const newTx = {
                id: txId,
                type: "Deposit",
                amount: amount,
                date: new Date().toISOString().slice(0, 10),
                status: "Pending",
                user: activeUser.identifier // for admin
            };
            
            // Add to activeUser's transactions array (Handle DB's lack of empty array)
            let transactionsArray = Array.isArray(activeUser.transactions) ? activeUser.transactions : (activeUser.transactions ? Object.values(activeUser.transactions) : []);
            transactionsArray.push(newTx);
            activeUser.transactions = transactionsArray;

            // Update Firebase
            await updateUserData(activeUser.identifier, {transactions: activeUser.transactions});

            depositFormMessage.textContent = `âœ… á‹¨ ${amount.toFixed(2)} ETB Deposit áŒ¥á‹«á‰„á‹ á‰ á‰°áˆ³áŠ« áˆáŠ”á‰³ áŒˆá‰¥á‰·áˆá¢ áŠ¥á‰£áŠ­á‹áŠ• á‹¨áŠ á‹µáˆšáŠ• áˆ›áˆ¨áŒ‹áŒˆáŒ« á‹­áŒ á‰¥á‰á¢`;
            depositFormMessage.classList.add('success');
            depositForm.reset();
        });

        // ***** 6.2. Withdraw áŠ á‹«á‹«á‹ *****
        withdrawBtn.addEventListener('click', () => {
            mainHomeContentDiv.style.display = 'none';
            depositPageContentDiv.style.display = 'none';
            withdrawPageContentDiv.style.display = 'block';
            withdrawFormMessage.textContent = '';
            withdrawForm.reset();
        });

        backToHomeFromWithdrawBtn.addEventListener('click', () => {
            mainHomeContentDiv.style.display = 'block';
            withdrawPageContentDiv.style.display = 'none';
            withdrawFormMessage.textContent = '';
        });

        withdrawForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!activeUser) return logout();

            const amount = parseFloat(withdrawAmountInput.value);
            const bankName = withdrawBankNameInput.value;
            const fullName = withdrawFullNameInput.value.trim();
            const accountNumber = withdrawAccountNumberInput.value.trim();

            withdrawFormMessage.textContent = '';
            withdrawFormMessage.classList.remove('success', 'error');

            if (amount < 100) {
                withdrawFormMessage.textContent = 'âš ï¸ á‰¢á‹«áŠ•áˆµ 100 ETB áˆ›á‹áŒ£á‰µ á‹­á‰½áˆ‹áˆ‰á¢';
                withdrawFormMessage.classList.add('error');
                return;
            }
            if (amount > activeUser.balance) {
                withdrawFormMessage.textContent = `âš ï¸ á‰ á‰‚ á‰€áˆª áˆ‚áˆ³á‰¥ á‹¨áˆá‰µáˆ! (${activeUser.balance.toFixed(2)} ETB áŠá‹ á‹«áˆˆá‹)`;
                withdrawFormMessage.classList.add('error');
                return;
            }

            // áŒˆáŠ•á‹˜á‰¡áŠ• áŠ¨áˆ˜áˆˆá‹«á‹ áˆ‹á‹­ áˆ˜á‰€áŠáˆµ
            activeUser.balance -= amount;

            const newTx = {
                id: 'tx_withdraw_' + Date.now(),
                type: "Withdraw",
                amount: amount,
                date: new Date().toISOString().slice(0, 10),
                status: "Pending",
                user: activeUser.identifier,
                bankName: bankName,
                fullName: fullName,
                accountNumber: accountNumber
            };

            // Add to activeUser's transactions array
            let transactionsArray = Array.isArray(activeUser.transactions) ? activeUser.transactions : (activeUser.transactions ? Object.values(activeUser.transactions) : []);
            transactionsArray.push(newTx);
            activeUser.transactions = transactionsArray;

            // Update Firebase
            await updateUserData(activeUser.identifier, {
                balance: activeUser.balance,
                transactions: activeUser.transactions
            });

            updateDashboardData(); // á‰€áˆª áˆ‚áˆ³á‰¥áŠ• á‹ˆá‹²á‹«á‹áŠ‘ áˆ›á‹˜áˆ˜áŠ•

            withdrawFormMessage.textContent = `âœ… á‹¨ ${amount.toFixed(2)} ETB Withdraw áŒ¥á‹«á‰„á‹ á‰ á‰°áˆ³áŠ« áˆáŠ”á‰³ áŒˆá‰¥á‰·áˆá¢ áŠ¥á‰£áŠ­á‹áŠ• á‹¨áŠ á‹µáˆšáŠ• áˆ›áˆ¨áŒ‹áŒˆáŒ« á‹­áŒ á‰¥á‰á¢`;
            withdrawFormMessage.classList.add('success');
            withdrawForm.reset();
        });


        // ***** 6.3. Investment áŠ á‹«á‹«á‹ *****
        planButtons.forEach(button => {
            button.addEventListener('click', function() {
                selectedPlan = {
                    name: this.getAttribute('data-plan'),
                    min: parseInt(this.getAttribute('data-min')),
                    max: parseInt(this.getAttribute('data-max')),
                    rate: parseInt(this.getAttribute('data-rate')),
                    days: parseInt(this.getAttribute('data-days'))
                };

                selectedPlanNameDisplay.textContent = selectedPlan.name;
                planInfoDisplay.textContent = `áˆ˜áŒ áŠ•: ${selectedPlan.min} - ${selectedPlan.max} ETB | á‹•áˆˆá‰³á‹Š á‰µáˆ­á: ${selectedPlan.rate}% | áˆˆ ${selectedPlan.days} á‰€áŠ“á‰µ`;
                purchaseAmountInput.min = selectedPlan.min;
                purchaseAmountInput.max = selectedPlan.max;
                purchaseAmountInput.value = selectedPlan.min;
                purchaseFormMessage.textContent = '';

                planGridList.style.display = 'none';
                purchaseFormBox.style.display = 'block';
            });
        });

        backToPlansBtn.addEventListener('click', () => {
            purchaseFormBox.style.display = 'none';
            planGridList.style.display = 'flex';
            selectedPlan = null;
        });

        purchaseForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!activeUser || !selectedPlan) return;

            const amount = parseFloat(purchaseAmountInput.value);
            purchaseFormMessage.textContent = '';
            purchaseFormMessage.classList.remove('success', 'error');

            if (amount < selectedPlan.min || amount > selectedPlan.max) {
                purchaseFormMessage.textContent = `âš ï¸ á‹¨áŒˆá‰£á‹ áˆ˜áŒ áŠ• áˆˆ ${selectedPlan.name} á‹•á‰…á‹µ á‰µáŠ­áŠ­áˆˆáŠ› áŠ á‹­á‹°áˆˆáˆ (${selectedPlan.min} - ${selectedPlan.max} ETB)á¢`;
                purchaseFormMessage.classList.add('error');
                return;
            }
            if (amount > activeUser.balance) {
                purchaseFormMessage.textContent = `âš ï¸ á‰ á‰‚ á‰€áˆª áˆ‚áˆ³á‰¥ (${activeUser.balance.toFixed(2)} ETB) á‹¨áˆá‰µáˆá¢`;
                purchaseFormMessage.classList.add('error');
                return;
            }

            // 1. Transaction Create
            activeUser.balance -= amount;
            activeUser.totalInvested = (activeUser.totalInvested || 0) + amount;

            const newTx = {
                id: 'tx_invest_' + Date.now(),
                type: "Investment Purchase",
                amount: amount,
                date: new Date().toISOString().slice(0, 10),
                status: "Completed",
                details: `${selectedPlan.name} Plan`
            };
            
            let transactionsArray = Array.isArray(activeUser.transactions) ? activeUser.transactions : (activeUser.transactions ? Object.values(activeUser.transactions) : []);
            transactionsArray.push(newTx);
            activeUser.transactions = transactionsArray;


            // 2. Investment Create
            const newInvestment = {
                id: 'inv_' + Date.now(),
                name: selectedPlan.name,
                amount: amount,
                rate: selectedPlan.rate,
                daysTotal: selectedPlan.days,
                daysLeft: selectedPlan.days,
                profitEarned: 0.0,
                startDate: new Date().toISOString().slice(0, 10)
            };

            let investmentsArray = Array.isArray(activeUser.investments) ? activeUser.investments : (activeUser.investments ? Object.values(activeUser.investments) : []);
            investmentsArray.push(newInvestment);
            activeUser.investments = investmentsArray;

            
            // 3. Referral Bonus (80 ETB) Check - only for the first investment
            if (activeUser.referredBy) {
                const isFirstInvestment = investmentsArray.filter(i => i.type === "Investment Purchase").length === 1;
                
                if (isFirstInvestment) {
                    const referrerIdentifier = activeUser.referredBy;
                    const referrer = await getUserData(referrerIdentifier);
                    
                    if (referrer) {
                        const bonusAmount = 80.00;
                        referrer.balance += bonusAmount;
                        
                        const bonusTx = {
                            id: 'tx_referral_bonus_' + Date.now(),
                            type: "Referral Bonus",
                            amount: bonusAmount,
                            date: new Date().toISOString().slice(0, 10),
                            status: "Completed",
                            details: `Bonus from ${activeUser.name} (${activeUser.identifier}) first investment`
                        };
                        
                        let referrerTxs = Array.isArray(referrer.transactions) ? referrer.transactions : (referrer.transactions ? Object.values(referrer.transactions) : []);
                        referrerTxs.push(bonusTx);
                        referrer.transactions = referrerTxs;
                        
                        // Update Referrer in Firebase
                        await updateUserData(referrerIdentifier, {
                            balance: referrer.balance,
                            transactions: referrer.transactions
                        });
                    }
                }
            }
            
            // 4. Update Active User in Firebase
            await updateUserData(activeUser.identifier, {
                balance: activeUser.balance,
                totalInvested: activeUser.totalInvested,
                transactions: activeUser.transactions,
                investments: activeUser.investments
            });

            purchaseFormMessage.textContent = `âœ… á‹¨ ${amount.toFixed(2)} ETB ${selectedPlan.name} áŠ¢áŠ•á‰¨áˆµá‰µáˆ˜áŠ•á‰µ á‰ á‰°áˆ³áŠ« áˆáŠ”á‰³ áŒˆá‹á‰°á‹‹áˆá¢ á‹•áˆˆá‰³á‹Š á‰µáˆ­áá‹ áŠ áˆáŠ• á‹­áŒ€áˆáˆ«áˆ!`;
            purchaseFormMessage.classList.add('success');
            
            updateDashboardData(); // Update UI
            
            setTimeout(() => {
                purchaseFormBox.style.display = 'none';
                planGridList.style.display = 'flex';
                selectedPlan = null;
            }, 3000);
        });


        // ***** 6.4. Account áŒˆáŒ½ á‰°áŒá‰£áˆ«á‰µ *****

        // A. á‹¨á‹­áˆˆá á‰ƒáˆ á‰€á‹­áˆ­
        changePasswordBtn.addEventListener('click', async () => {
            if (!activeUser) return;
            // ... (á‹¨á‹µáˆ® á‹¨á‹­áˆˆá á‰ƒáˆ á‰¼áŠ­ áŠ¥áŠ“ áŠ á‹²áˆµ á‹¨á‹­áˆˆá á‰ƒáˆ áˆ›áˆµáŒˆá‰¢á‹« logic á‰°áˆ˜áˆ³áˆ³á‹­ áŠá‹) ...
            let oldPassword;
            let newPassword;
            let confirmPassword;
            let attempts = 0;
            
            while (attempts < 3) {
                oldPassword = prompt("á‹¨á‹µáˆ® á‹¨á‹­áˆˆá á‰ƒáˆá‹áŠ• á‹«áˆµáŒˆá‰¡:");
                if (oldPassword === null) { alert("á‹¨á‹­áˆˆá á‰ƒáˆ áˆ˜á‰€á‹¨áˆ­ á‰°á‰‹áˆ­áŒ§áˆá¢"); return; }
                if (oldPassword !== activeUser.password) { alert("á‹¨á‰°áˆ³áˆ³á‰° á‹¨á‹­áˆˆá á‰ƒáˆ! áŠ¥áŠ•á‹°áŒˆáŠ“ á‹­áˆáŠ­áˆ©á¢"); attempts++; continue; }

                newPassword = prompt("áŠ á‹²áˆ±áŠ• á‹¨á‹­áˆˆá á‰ƒáˆá‹áŠ• á‹«áˆµáŒˆá‰¡ (á‰¢á‹«áŠ•áˆµ 6 áŠá‹°áˆ):");
                if (newPassword === null) { alert("á‹¨á‹­áˆˆá á‰ƒáˆ áˆ˜á‰€á‹¨áˆ­ á‰°á‰‹áˆ­áŒ§áˆá¢"); return; }
                if (newPassword.length < 6) { alert("á‹¨á‹­áˆˆá á‰ƒáˆá‹ á‰¢á‹«áŠ•áˆµ 6 áŠá‹°áˆ‹á‰µ áˆ˜áˆ†áŠ• áŠ áˆˆá‰ á‰µá¢"); attempts++; continue; }
                if (newPassword === oldPassword) { alert("áŠ á‹²áˆ± á‹¨á‹­áˆˆá á‰ƒáˆá‹ áŠ¨á‹µáˆ®á‹ á‹¨á‹­áˆˆá á‰ƒáˆ áŒ‹áˆ­ áˆ˜áˆ˜áˆ³áˆ°áˆ á‹¨áˆˆá‰ á‰µáˆá¢"); attempts++; continue; }

                confirmPassword = prompt("áŠ á‹²áˆ±áŠ• á‹¨á‹­áˆˆá á‰ƒáˆá‹áŠ• áŠ¥áŠ•á‹°áŒˆáŠ“ á‰ áˆ›áˆµáŒˆá‰£á‰µ á‹«áˆ¨áŒ‹áŒáŒ¡:");
                if (confirmPassword === null) { alert("á‹¨á‹­áˆˆá á‰ƒáˆ áˆ˜á‰€á‹¨áˆ­ á‰°á‰‹áˆ­áŒ§áˆá¢"); return; }
                
                if (newPassword === confirmPassword) {
                    // Update Firebase
                    activeUser.password = newPassword;
                    await updateUserData(activeUser.identifier, { password: newPassword });

                    alert("âœ… á‹¨á‹­áˆˆá á‰ƒáˆá‹ á‰ á‰°áˆ³áŠ« áˆáŠ”á‰³ á‰°á‰€á‹­áˆ¯áˆá¢ áŠ á‹²áˆ±áŠ• á‹­áˆˆá á‰ƒáˆ á‰ áˆ˜áŒ á‰€áˆ á‹ˆá‹°áŠá‰µ á‹­áŒá‰¡á¢");
                    return;
                } else {
                    alert("á‹¨á‹­áˆˆá á‰ƒáˆá‰¹ áŠ á‹­áˆ˜áˆ³áˆ°áˆ‰áˆ! áŠ¥áŠ•á‹°áŒˆáŠ“ á‹­áˆáŠ­áˆ©á¢");
                    attempts++;
                }
            }
            alert("âš ï¸ á‹¨á‹­áˆˆá á‰ƒáˆá‹áŠ• á‰ á‰°á‹°áŒ‹áŒ‹áˆš áˆ˜áˆˆá‹ˆáŒ¥ áŠ áˆá‰»áˆ‰áˆá¢ á‰ áŠ‹áˆ‹ á‹­áˆáŠ­áˆ©á¢");
        });

        // B. á‹¨á‹á‹á‹áˆ­ á‰³áˆªáŠ­ (Transaction History) áŠ áˆ³á‹­
        transactionHistoryBtn.addEventListener('click', () => {
            if (!activeUser) return;
            let historyHTML = '<h4>á‹¨á‹á‹á‹áˆ­ á‰³áˆªáŠ­</h4>';

            if (!activeUser.transactions || activeUser.transactions.length === 0) {
                historyHTML += '<p>áˆáŠ•áˆ á‹¨á‹á‹á‹áˆ­ á‰³áˆªáŠ­ á‹¨áˆˆáˆá¢</p>';
            } else {
                // Transactions arrayáŠ• áŠ¨ Object.values á‹¨áˆ˜áŒ£ áŠ¨áˆ†áŠ á‹ˆá‹° Array áˆ˜á‰€á‹¨áˆ­
                const transactionsArray = Array.isArray(activeUser.transactions) ? activeUser.transactions : Object.values(activeUser.transactions);
                
                // á‰ áŠ á‹²áˆµ á‰€áŠ• áˆ˜áŒ€áˆ˜áˆªá‹« áŠ¥áŠ•á‹²áˆ†áŠ• áˆ˜á‹°áˆ­á‹°áˆ­
                transactionsArray.sort((a, b) => new Date(b.date) - new Date(a.date));

                historyHTML += '<table style="width:100%; border-collapse: collapse; margin-top: 15px;">';
                historyHTML += '<thead><tr style="background-color: #f2f2f2; text-align: left;"><th>á‰€áŠ•</th><th>á‹“á‹­áŠá‰µ</th><th>áˆ˜áŒ áŠ•</th><th>áˆáŠ”á‰³</th></tr></thead><tbody>';

                transactionsArray.forEach(tx => {
                    const statusClass = `status-${tx.status}`;
                    const sign = tx.type.includes('Deposit') || tx.type.includes('Bonus') || tx.type.includes('Profit') ? '+' : (tx.type.includes('Withdraw') ? '-' : '');
                    const color = sign === '+' ? '#387c38' : (sign === '-' ? '#f44336' : '#555');

                    historyHTML += `
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px;">${tx.date}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${tx.type}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; color: ${color};">${sign}${tx.amount.toFixed(2)} ETB</td>
                            <td style="border: 1px solid #ddd; padding: 8px;" class="${statusClass}">${tx.status}</td>
                        </tr>
                    `;
                });

                historyHTML += '</tbody></table>';
            }

            historyMessage.innerHTML = historyHTML;
        });
        
        // C. Customer Service Button
        document.getElementById('customer-service-btn').addEventListener('click', () => {
            const telegramUsername = 'Lucia_ipo';
            window.open(`https://t.me/${telegramUsername}`, '_blank');
        });

        // D. Logout
        function logout() {
            activeUser = null;
            isAdmin = false;
            loginRegisterArea.style.display = 'flex';
            dashboardArea.style.display = 'none';
            adminDashboardArea.style.display = 'none';
            loginForm.reset();
            switchAuthTab('login');
        }
        logoutBtnAccount.addEventListener('click', logout);
        adminLogoutBtn.addEventListener('click', logout);
        
        // ***** 6.5. My Team áŒˆáŒ½ á‰°áŒá‰£áˆ«á‰µ *****
        copyCodeBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(referralCodeDisplay.textContent).then(() => {
                alert('âœ… Referral Code á‰ á‰°áˆ³áŠ« áˆáŠ”á‰³ á‰°á‰€á‹µá‰·áˆá¢');
            }, () => {
                alert('âš ï¸ Referral Code áˆ˜á‰…á‹³á‰µ áŠ áˆá‰°á‰»áˆˆáˆá¢ á‰ áŠ¥áŒ… á‹­á‰…á‹±á‰µá¢');
            });
        });

        copyLinkBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(referralLinkDisplay.textContent).then(() => {
                alert('âœ… á‹¨áˆ˜áˆ˜á‹áŒˆá‰¢á‹« áˆŠáŠ•áŠ­ á‰ á‰°áˆ³áŠ« áˆáŠ”á‰³ á‰°á‰€á‹µá‰·áˆá¢');
            }, () => {
                alert('âš ï¸ á‹¨áˆ˜áˆ˜á‹áŒˆá‰¢á‹« áˆŠáŠ•áŠ­ áˆ˜á‰…á‹³á‰µ áŠ áˆá‰°á‰»áˆˆáˆá¢ á‰ áŠ¥áŒ… á‹­á‰…á‹±á‰µá¢');
            });
        });

        // ********** 7. EVENT HANDLERS - NAVIGATION **********
        navHome.addEventListener('click', () => switchDashboardPage('home'));
        navInvestment.addEventListener('click', () => switchDashboardPage('investment'));
        navAccount.addEventListener('click', () => switchDashboardPage('account'));
        navTeam.addEventListener('click', () => switchDashboardPage('team'));
        
        goToRegisterLink.addEventListener('click', (e) => { e.preventDefault(); switchAuthTab('register'); });
        goToLoginLink.addEventListener('click', (e) => { e.preventDefault(); switchAuthTab('login'); });
        loginTab.addEventListener('click', () => switchAuthTab('login'));
        registerTab.addEventListener('click', () => switchAuthTab('register'));

        // ********** 8. ADMIN PANEL FUNCTIONALITY **********
        
        // á‹¨ Admin Panel áˆ‹á‹­ á‹«áˆ‰ Pending Transactions áˆ˜áˆ¨áŒƒá‹á‰½áŠ• áŠ¨ Firebase á‹«á‹ˆáŒ£áˆ
        async function displayPendingTransactions() {
            adminMessage.textContent = '';
            pendingTransactionsList.innerHTML = '<p style="text-align: center; color: #555;">Loading...</p>';

            try {
                const allUsers = await getAllUsersData();
                const allUsersArray = Object.values(allUsers);
                let pendingTxs = [];

                allUsersArray.forEach(user => {
                    const userTxs = Array.isArray(user.transactions) ? user.transactions : (user.transactions ? Object.values(user.transactions) : []);
                    const userPending = userTxs.filter(t => t.status === "Pending");
                    
                    userPending.forEach(tx => {
                        pendingTxs.push({
                            ...tx,
                            userName: user.name,
                            userId: user.identifier // The user's phone number
                        });
                    });
                });
                
                pendingTransactionsList.innerHTML = ''; // Clear existing list

                if (pendingTxs.length === 0) {
                    pendingTransactionsList.innerHTML = '<p style="text-align: center; color: #555;">áˆáŠ•áˆ á‰ áˆ˜áŒ á‰£á‰ á‰… áˆ‹á‹­ á‹«áˆˆ áŒ¥á‹«á‰„ á‹¨áˆˆáˆá¢</p>';
                    return;
                }

                pendingTxs.forEach(tx => {
                    const info = tx.type === 'Deposit' 
                        ? `Transaction ID: ${tx.id}` 
                        : `Bank: ${tx.bankName} | Account: ${tx.accountNumber} | Name: ${tx.fullName}`;

                    const txHtml = `
                        <div class="admin-transaction-item">
                            <div class="admin-transaction-info">
                                <p style="font-size: 16px; margin-bottom: 5px;"><strong>${tx.type} - ${tx.amount.toFixed(2)} ETB</strong></p>
                                <p>á‰°áŒ á‰ƒáˆš: ${tx.userName} (${tx.userId})</p>
                                <p style="color: #777; font-size: 12px;">${info}</p>
                                <p style="font-size: 12px;">á‰€áŠ•: ${tx.date}</p>
                            </div>
                            <div class="admin-actions">
                                <button class="approve-btn" data-tx-id="${tx.id}" data-user-id="${tx.userId}" data-tx-type="${tx.type}" data-tx-amount="${tx.amount}">âœ… áŠ á…á‹µá‰… (Approve)</button>
                                <button class="reject-btn" data-tx-id="${tx.id}" data-user-id="${tx.userId}" data-tx-type="${tx.type}" data-tx-amount="${tx.amount}">âŒ á‹á‹µá‰… áŠ á‹µáˆ­áŒ (Reject)</button>
                            </div>
                        </div>
                    `;
                    pendingTransactionsList.insertAdjacentHTML('beforeend', txHtml);
                });

                // Attach event listeners to the new buttons
                document.querySelectorAll('.admin-actions button').forEach(button => {
                    button.addEventListener('click', function() {
                        const action = this.classList.contains('approve-btn') ? 'approve' : 'reject';
                        const txId = this.getAttribute('data-tx-id');
                        const userId = this.getAttribute('data-user-id');
                        const txType = this.getAttribute('data-tx-type');
                        const txAmount = parseFloat(this.getAttribute('data-tx-amount'));
                        
                        handleAdminAction(txId, userId, txType, txAmount, action);
                    });
                });

            } catch (error) {
                console.error("Error fetching pending transactions:", error);
                adminMessage.textContent = 'âš ï¸ áˆ˜áˆ¨áŒƒá‹áŠ• áŠ¨ Firebase áˆ›á‹áŒ£á‰µ áŠ áˆá‰°á‰»áˆˆáˆá¢';
            }
        }

        // á‹¨ Admin Panel áˆ‹á‹­ Approve/Reject áˆ²á‹°áˆ¨áŒ
        async function handleAdminAction(txId, userId, txType, txAmount, action) {
            if (!isAdmin) return;
            
            const user = await getUserData(userId);
            if (!user) {
                alert("á‹¨á‰°áŒ á‰ƒáˆš áˆ˜áˆ¨áŒƒ áŠ áˆá‰°áŒˆáŠ˜áˆ!");
                return;
            }
            
            // Transactions arrayáŠ• áŠ¨ Object.values á‹¨áˆ˜áŒ£ áŠ¨áˆ†áŠ á‹ˆá‹° Array áˆ˜á‰€á‹¨áˆ­
            let userTxs = Array.isArray(user.transactions) ? user.transactions : (user.transactions ? Object.values(user.transactions) : []);
            
            const txIndex = userTxs.findIndex(t => t.id === txId && t.status === "Pending");
            const transaction = userTxs[txIndex];

            if (txIndex === -1) {
                alert("á‹­áˆ… áŒ¥á‹«á‰„ á‹ˆá‹­ á‰°áˆ¨áŒ‹áŒáŒ§áˆ á‹ˆá‹­áˆ á‰°áˆ°áˆ­á‹Ÿáˆá¢");
                displayPendingTransactions();
                return;
            }

            if (action === 'approve') {
                transaction.status = "Completed";
                if (txType === 'Deposit') {
                    user.balance = (user.balance || 0) + txAmount;
                    alert(`âœ… á‹¨ ${txAmount.toFixed(2)} ETB Deposit áˆˆ ${user.name} áŒˆá‰¢ á‰°á‹°áˆ­áŒ“áˆá¢`);
                } else if (txType === 'Withdraw') {
                    // Withdraw áˆ‹á‹­ á‰€á‹°áˆ á‰¥áˆ áŒˆáŠ•á‹˜á‰¡ áˆµáˆˆá‰°á‰€áŠáˆ°á£ áˆáŠ•áˆ áˆ›á‹µáˆ¨áŒ áŠ á‹­áŒ á‰ á‰…áˆ
                    alert(`âœ… á‹¨ ${txAmount.toFixed(2)} ETB Withdraw áŒ¥á‹«á‰„ á‰°áˆá…áˆŸáˆá¢`);
                }
            } else if (action === 'reject') {
                transaction.status = "Rejected";
                
                if (txType === 'Withdraw') {
                    // á‰€á‹°áˆ á‰¥áˆ á‹¨á‰°á‰€áŠáˆ°á‹áŠ• áŒˆáŠ•á‹˜á‰¥ áˆ˜áˆ˜áˆˆáˆµ
                    user.balance = (user.balance || 0) + txAmount;
                    alert(`âŒ á‹¨ ${txAmount.toFixed(2)} ETB Withdraw áŒ¥á‹«á‰„ á‹á‹µá‰… á‰°á‹°áˆ­áŒ“áˆá¢ áŒˆáŠ•á‹˜á‰¡ á‰°áˆ˜áˆáˆ·áˆá¢`);
                } else if (txType === 'Deposit') {
                    alert(`âŒ á‹¨ ${txAmount.toFixed(2)} ETB Deposit áŒ¥á‹«á‰„ á‹á‹µá‰… á‰°á‹°áˆ­áŒ“áˆá¢`);
                }
            }
            
            // Update the user object in Firebase
            await updateUserData(userId, {
                balance: user.balance,
                transactions: userTxs // á‹¨á‰°áˆ»áˆ»áˆˆá‹ Transaction array
            });

            // á‹áˆ­á‹áˆ©áŠ• áˆ›á‹°áˆµ
            displayPendingTransactions();
            
            // á‰°áŒ á‰ƒáˆšá‹ áŒˆá‰¥á‰¶ áŠ¨áˆ†áŠ á‹¨ Dashboard á‹³á‰³á‹áŠ• áˆ›á‹°áˆµ (áˆˆá‰°áŒ á‰ƒáˆšá‹ áˆ›áˆ³á‹¨á‰µ)
            if (activeUser && activeUser.identifier === user.identifier) {
                updateDashboardData();
            }
        }


        // ********** 9. Initialization (áŒˆáŒ¹ áˆ²áŠ¨áˆá‰µ) **********
        // á‰ áŒˆáŒ½ áˆá‹µ áŒŠá‹œ áˆ˜áŒ€áˆ˜áˆªá‹« Login/Register áŒˆáŒ½áŠ• áˆ›áˆ³á‹¨á‰µ
        loginRegisterArea.style.display = 'flex';
        dashboardArea.style.display = 'none';
        adminDashboardArea.style.display = 'none';
        purchaseFormBox.style.display = 'none'; // á‹¨ Investment áŒá‹¢ á‰…áŒ½áŠ• áˆ˜á‹°á‰ á‰…
        
    </script>
</body>
</html>